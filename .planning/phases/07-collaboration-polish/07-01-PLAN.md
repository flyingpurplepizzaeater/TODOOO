---
phase: 07-collaboration-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/components/Canvas/collaboration/useAwareness.ts
  - frontend/src/components/Canvas/collaboration/collaboratorColors.ts
  - frontend/src/components/Canvas/collaboration/types.ts
  - frontend/src/components/Canvas/collaboration/index.ts
  - frontend/src/lib/yjs/provider.ts
autonomous: true

must_haves:
  truths:
    - "Local cursor position broadcasts to other clients in real-time"
    - "Remote cursor positions are received and available as TLInstancePresence"
    - "Each user has a consistent color derived from their ID"
    - "Cursor updates are throttled to prevent network flooding"
  artifacts:
    - path: "frontend/src/components/Canvas/collaboration/useAwareness.ts"
      provides: "Awareness hook for cursor/presence sync"
      exports: ["useAwareness"]
    - path: "frontend/src/components/Canvas/collaboration/collaboratorColors.ts"
      provides: "Color palette and deterministic color assignment"
      exports: ["COLLABORATOR_COLORS", "colorFromUserId"]
    - path: "frontend/src/components/Canvas/collaboration/types.ts"
      provides: "AwarenessState interface"
      exports: ["AwarenessState"]
  key_links:
    - from: "frontend/src/components/Canvas/collaboration/useAwareness.ts"
      to: "provider.awareness"
      via: "WebsocketProvider awareness API"
      pattern: "provider\\.awareness\\.(setLocalState|getStates|on)"
    - from: "frontend/src/components/Canvas/collaboration/useAwareness.ts"
      to: "editor.store"
      via: "mergeRemoteChanges for TLInstancePresence"
      pattern: "store\\.mergeRemoteChanges"
---

<objective>
Create the Yjs Awareness integration for cursor and presence synchronization.

Purpose: This plan establishes the foundation for all collaboration features by connecting
tldraw to the Yjs Awareness protocol. Cursor positions, user info, and activity status
will sync automatically through the existing y-websocket provider.

Output: useAwareness hook, collaborator color system, and AwarenessState type definitions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-collaboration-polish/07-CONTEXT.md
@.planning/phases/07-collaboration-polish/07-RESEARCH.md

@frontend/src/lib/yjs/provider.ts
@frontend/src/components/Canvas/useYjsStore.ts
@frontend/src/components/Canvas/Canvas.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create collaboration types and color palette</name>
  <files>
    frontend/src/components/Canvas/collaboration/types.ts
    frontend/src/components/Canvas/collaboration/collaboratorColors.ts
    frontend/src/components/Canvas/collaboration/index.ts
  </files>
  <action>
Create the collaboration module directory and foundational files.

**types.ts** - Define AwarenessState interface:
```typescript
export interface AwarenessState {
  user: {
    id: string
    name: string
    color: string  // Hex color for cursor/avatar
  }
  cursor: {
    x: number
    y: number
    type: 'default' | 'pointer' | 'grab'
    rotation: number
  } | null  // null when cursor leaves canvas
  selection: string[]  // Array of selected shape IDs
  viewport: {
    x: number
    y: number
    zoom: number
  } | null
  lastActivity: number  // Timestamp for idle detection
  isIdle: boolean       // Set after 2min inactivity
}
```

**collaboratorColors.ts** - 12-color palette optimized for distinguishability:
```typescript
export const COLLABORATOR_COLORS = [
  '#FF6B6B',  // Red
  '#4ECDC4',  // Teal
  '#FFE66D',  // Yellow
  '#95E1D3',  // Mint
  '#F38181',  // Coral
  '#6C5CE7',  // Purple
  '#00B894',  // Green
  '#FDCB6E',  // Gold
  '#74B9FF',  // Blue
  '#E17055',  // Orange
  '#A29BFE',  // Lavender
  '#55A3FF',  // Sky
]

export function colorFromUserId(userId: string): string {
  // Deterministic hash from userId
  let hash = 0
  for (let i = 0; i < userId.length; i++) {
    hash = ((hash << 5) - hash) + userId.charCodeAt(i)
    hash = hash & hash  // Convert to 32-bit int
  }
  return COLLABORATOR_COLORS[Math.abs(hash) % COLLABORATOR_COLORS.length]
}
```

**index.ts** - Barrel export for clean imports.
  </action>
  <verify>TypeScript compiles: `cd frontend && npx tsc --noEmit`</verify>
  <done>Types and colors are importable from 'components/Canvas/collaboration'</done>
</task>

<task type="auto">
  <name>Task 2: Create useAwareness hook with cursor sync</name>
  <files>
    frontend/src/components/Canvas/collaboration/useAwareness.ts
    frontend/src/lib/yjs/provider.ts
  </files>
  <action>
Create the useAwareness hook that integrates Yjs Awareness with tldraw.

**Update provider.ts** to expose provider along with doc:
- Return type should include the provider reference (already does, just ensure it's accessible)

**useAwareness.ts** - Core awareness hook:

1. **Interface for hook options:**
```typescript
interface UseAwarenessOptions {
  provider: WebsocketProvider
  editor: Editor
  user: { id: string; name: string }
}
```

2. **State management:**
- Track `others: Map<number, AwarenessState>` for remote users
- Store `localClientId` from provider.awareness.clientID

3. **Initialize local awareness state on mount:**
```typescript
awareness.setLocalState({
  user: {
    id: user.id,
    name: user.name,
    color: colorFromUserId(user.id)
  },
  cursor: null,
  selection: [],
  viewport: null,
  lastActivity: Date.now(),
  isIdle: false
})
```

4. **Subscribe to awareness changes:**
- Filter out local clientId when processing
- Update `others` state with remote awareness data
- Clean up subscription on unmount
- CRITICAL: Set local state to null on unmount to prevent ghost cursors

5. **Throttled cursor position updates (50ms):**
- Create throttled function using setTimeout (avoid lodash dependency)
- Update cursor position: `{ x, y, type: 'default', rotation: 0 }`
- Also update lastActivity timestamp with each cursor move

6. **Track editor pointer-move events:**
- Use editor.store.listen to detect pointer moves
- Call throttled cursor update with canvas coordinates

7. **Sync remote presence to tldraw store:**
- Use InstancePresenceRecordType from tldraw
- Convert AwarenessState to TLInstancePresence
- Call editor.store.mergeRemoteChanges(() => store.put(presenceRecords))
- Remove presence records for disconnected users

8. **Return values:**
```typescript
return {
  others,           // Map of remote user states
  localClientId,    // This client's awareness ID
  updateCursor,     // Manual cursor update function
  clearCursor,      // Set cursor to null (on canvas leave)
}
```

**Key implementation notes from RESEARCH.md:**
- Always include `lastActivityTimestamp: state.lastActivity` in presence records (tldraw hides cursors without it)
- Filter `clientId !== localClientId` to prevent echo loops
- Use `store.mergeRemoteChanges()` to mark changes as remote
  </action>
  <verify>
TypeScript compiles: `cd frontend && npx tsc --noEmit`
Hook exports correctly: Check barrel export in index.ts includes useAwareness
  </verify>
  <done>
useAwareness hook creates presence records visible in tldraw store.
Cursor updates are throttled to 50ms intervals.
Remote users appear in `others` Map with their cursor positions.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate awareness into Canvas component</name>
  <files>
    frontend/src/components/Canvas/Canvas.tsx
    frontend/src/components/Canvas/useYjsStore.ts
  </files>
  <action>
Wire the useAwareness hook into the Canvas component.

**Update useYjsStore.ts:**
- Add providerRef to track WebsocketProvider
- Return provider in the result object (or expose via ref)
- Need provider reference for useAwareness

**Update Canvas.tsx:**

1. **Add mock user info (will be replaced with real auth later):**
```typescript
// TODO: Replace with actual user from auth context
const currentUser = useMemo(() => ({
  id: 'user-' + Math.random().toString(36).slice(2, 9),
  name: 'Anonymous User'
}), [])
```

2. **Get provider from useYjsStore result**

3. **Call useAwareness when editor is ready:**
```typescript
const { others } = useAwareness({
  provider,
  editor,
  user: currentUser
})
```
- Only call after editor is mounted (check editor !== null)
- Pass provider from useYjsStore

4. **Handle canvas mouse leave:**
- Add onMouseLeave to canvas container div
- Call awareness clearCursor() to remove cursor from other clients' view

5. **Track selection changes:**
- Subscribe to editor selection changes
- Update awareness selection array when user selects shapes

**Implementation detail:** The useAwareness hook handles most of the work. Canvas.tsx
just needs to wire it up and handle the mouse leave event.
  </action>
  <verify>
Build succeeds: `cd frontend && npm run build`
No TypeScript errors
Console shows awareness state updates when moving cursor (add temporary console.log)
  </verify>
  <done>
Canvas component initializes awareness on mount.
Moving cursor updates local awareness state.
Mouse leave clears cursor from awareness.
Provider is accessible for awareness hook.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Type check:** `cd frontend && npx tsc --noEmit`
2. **Build check:** `cd frontend && npm run build`
3. **Code review:**
   - useAwareness sets local state with user info and color
   - Cursor updates are throttled (check for setTimeout/throttle pattern)
   - Remote presence syncs to tldraw store via mergeRemoteChanges
   - Local state cleared on unmount (prevents ghost cursors)
   - colorFromUserId returns consistent color for same ID
</verification>

<success_criteria>
- Awareness hook compiles and exports correctly
- Color palette has 12 distinct colors
- colorFromUserId is deterministic (same input = same output)
- Cursor position updates throttled to ~50ms
- Canvas integrates awareness without TypeScript errors
- Provider is accessible from useYjsStore result
</success_criteria>

<output>
After completion, create `.planning/phases/07-collaboration-polish/07-01-SUMMARY.md`
</output>
