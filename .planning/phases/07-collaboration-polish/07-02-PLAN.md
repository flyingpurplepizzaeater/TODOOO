---
phase: 07-collaboration-polish
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - frontend/src/components/Canvas/collaboration/DotCursor.tsx
  - frontend/src/components/Canvas/collaboration/CollaboratorIndicator.tsx
  - frontend/src/components/Canvas/collaboration/index.ts
  - frontend/src/components/Canvas/Canvas.tsx
autonomous: true

must_haves:
  truths:
    - "Remote users' cursors appear as colored dots on canvas"
    - "Hovering a cursor reveals the username label"
    - "Objects selected by other users show colored selection outlines"
    - "Cursor size remains consistent regardless of zoom level"
  artifacts:
    - path: "frontend/src/components/Canvas/collaboration/DotCursor.tsx"
      provides: "Custom dot-shaped cursor component"
      exports: ["DotCursor"]
    - path: "frontend/src/components/Canvas/collaboration/CollaboratorIndicator.tsx"
      provides: "Selection outline component for collaborator shapes"
      exports: ["CollaboratorIndicator"]
  key_links:
    - from: "frontend/src/components/Canvas/Canvas.tsx"
      to: "DotCursor"
      via: "TLComponents.CollaboratorCursor"
      pattern: "components.*CollaboratorCursor.*DotCursor"
    - from: "frontend/src/components/Canvas/collaboration/DotCursor.tsx"
      to: "TLCursorProps"
      via: "tldraw cursor component interface"
      pattern: "TLCursorProps|color.*name.*zoom"
---

<objective>
Create custom dot-shaped cursor and selection indicator components for collaborators.

Purpose: Per CONTEXT.md, cursors should be dot/circle shape (not arrow pointers) for an
unobtrusive collaborative feel. Username labels appear on hover only to keep the canvas
clean. Selection outlines show which objects other users have selected.

Output: DotCursor component, CollaboratorIndicator component, TLComponents configuration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-collaboration-polish/07-CONTEXT.md
@.planning/phases/07-collaboration-polish/07-RESEARCH.md
@.planning/phases/07-collaboration-polish/07-01-SUMMARY.md

@frontend/src/components/Canvas/Canvas.tsx
@frontend/src/components/Canvas/CustomToolbar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DotCursor component</name>
  <files>
    frontend/src/components/Canvas/collaboration/DotCursor.tsx
    frontend/src/components/Canvas/collaboration/index.ts
  </files>
  <action>
Create a custom cursor component that renders a dot instead of the default arrow cursor.

**DotCursor.tsx:**

1. **Import types from tldraw:**
```typescript
import { useState } from 'react'
// Note: TLCursorProps may not be directly exported - check tldraw types
// The component receives: { color, name, zoom, point } from tldraw
```

2. **Component signature:**
```typescript
interface DotCursorProps {
  color: string
  name: string | null
  zoom: number
}

export function DotCursor({ color, name, zoom }: DotCursorProps)
```

3. **State for hover:**
```typescript
const [showName, setShowName] = useState(false)
```

4. **Size calculation per CONTEXT.md (16-20px):**
```typescript
const BASE_SIZE = 18  // pixels at zoom 1.0
const size = BASE_SIZE / zoom  // Maintain consistent screen size
```

5. **Render structure:**
```tsx
<div
  style={{
    position: 'absolute',
    transform: 'translate(-50%, -50%)',  // Center on cursor position
  }}
  onMouseEnter={() => setShowName(true)}
  onMouseLeave={() => setShowName(false)}
>
  {/* Dot cursor */}
  <div
    style={{
      width: size,
      height: size,
      borderRadius: '50%',
      backgroundColor: color,
      border: '2px solid white',
      boxShadow: '0 1px 4px rgba(0,0,0,0.3)',
      transition: 'opacity 0.3s ease',  // For fade effect
    }}
  />

  {/* Username label - shown on hover only per CONTEXT.md */}
  {showName && name && (
    <div
      style={{
        position: 'absolute',
        top: size + 4,
        left: '50%',
        transform: 'translateX(-50%)',
        backgroundColor: color,
        color: 'white',
        padding: '2px 8px',
        borderRadius: 4,
        fontSize: 11,
        fontWeight: 500,
        whiteSpace: 'nowrap',
        boxShadow: '0 1px 3px rgba(0,0,0,0.2)',
        fontFamily: 'system-ui, sans-serif',
      }}
    >
      {name}
    </div>
  )}
</div>
```

6. **Update barrel export in index.ts**

**Implementation note:** tldraw's CollaboratorCursor component receives props including
color, name, and zoom. The exact interface should be verified against tldraw v4 types.
May need to check `@tldraw/editor` package for the exact type definition.
  </action>
  <verify>
TypeScript compiles: `cd frontend && npx tsc --noEmit`
Component exports correctly
  </verify>
  <done>
DotCursor renders a colored circle instead of arrow pointer.
Username label appears on hover only.
Size adjusts with zoom to maintain consistent screen appearance.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create CollaboratorIndicator for selection outlines</name>
  <files>
    frontend/src/components/Canvas/collaboration/CollaboratorIndicator.tsx
    frontend/src/components/Canvas/collaboration/index.ts
  </files>
  <action>
Create a component that shows colored outlines around shapes selected by other users.

**CollaboratorIndicator.tsx:**

Per CONTEXT.md: "Objects selected by others show colored selection outline (their cursor color)"

1. **Check tldraw's CollaboratorShapeIndicator pattern:**
tldraw provides a built-in component for this. We need to customize it to use the
collaborator's cursor color.

```typescript
import { useEditor, useValue } from 'tldraw'

interface CollaboratorIndicatorProps {
  shapeId: string
  color: string
  userName: string
}

export function CollaboratorIndicator({ shapeId, color, userName }: CollaboratorIndicatorProps)
```

2. **Get shape bounds:**
```typescript
const editor = useEditor()
const bounds = useValue(
  'shape bounds',
  () => editor.getShapePageBounds(shapeId),
  [editor, shapeId]
)
```

3. **Render colored outline:**
```tsx
if (!bounds) return null

return (
  <div
    style={{
      position: 'absolute',
      left: bounds.x,
      top: bounds.y,
      width: bounds.width,
      height: bounds.height,
      border: `2px solid ${color}`,
      borderRadius: 4,
      pointerEvents: 'none',
      boxSizing: 'border-box',
    }}
  >
    {/* Optional: small label showing who selected it */}
    <div
      style={{
        position: 'absolute',
        top: -20,
        left: 0,
        backgroundColor: color,
        color: 'white',
        padding: '1px 6px',
        borderRadius: 3,
        fontSize: 10,
        fontFamily: 'system-ui, sans-serif',
        whiteSpace: 'nowrap',
      }}
    >
      {userName}
    </div>
  </div>
)
```

4. **Alternative approach - Use tldraw's built-in system:**
If tldraw's CollaboratorShapeIndicator handles this automatically when presence
records include selection data, document that and provide minimal wrapper or just
configure via TLComponents.

**Research note from 07-RESEARCH.md:**
"Don't Build: Custom selection box - Use Instead: TLComponents.CollaboratorShapeIndicator"

Check if setting `selection: string[]` in awareness state automatically renders indicators.
If so, this component may just be a styled wrapper or may not be needed at all.
  </action>
  <verify>
TypeScript compiles: `cd frontend && npx tsc --noEmit`
Component handles null bounds gracefully
  </verify>
  <done>
Selection outlines appear in collaborator's cursor color.
Small label shows who selected the shape.
Component handles edge cases (deleted shapes, no bounds).
  </done>
</task>

<task type="auto">
  <name>Task 3: Configure TLComponents with custom cursor</name>
  <files>
    frontend/src/components/Canvas/Canvas.tsx
    frontend/src/components/Canvas/CustomToolbar.tsx
  </files>
  <action>
Wire the DotCursor component into tldraw via the components prop.

**Update Canvas.tsx or create separate collaborationComponents.ts:**

1. **Import DotCursor:**
```typescript
import { DotCursor } from './collaboration'
```

2. **Extend toolbarComponents with CollaboratorCursor:**
tldraw's TLComponents interface accepts CollaboratorCursor override.

```typescript
const collaborationComponents: TLComponents = {
  CollaboratorCursor: DotCursor,
  // CollaboratorShapeIndicator may also be customizable
}
```

3. **Merge with existing toolbarComponents:**
```typescript
const canvasComponents: TLComponents = {
  ...toolbarComponents,
  CollaboratorCursor: DotCursor,
}
```

4. **Update Tldraw component:**
```tsx
<Tldraw
  store={store}
  // ... other props
  components={canvasComponents}
/>
```

**Verification approach:**
Since we can't test with multiple users easily, add a temporary debug feature:
- Create a fake presence record in the store
- Verify the DotCursor renders at the fake cursor position

```typescript
// Temporary debug in handleMount:
if (process.env.NODE_ENV === 'development') {
  setTimeout(() => {
    ed.store.mergeRemoteChanges(() => {
      ed.store.put([
        InstancePresenceRecordType.create({
          id: InstancePresenceRecordType.createId('debug-user'),
          currentPageId: ed.getCurrentPageId(),
          userId: 'debug-user-id',
          userName: 'Debug User',
          color: '#FF6B6B',
          cursor: { x: 100, y: 100, type: 'default', rotation: 0 },
          lastActivityTimestamp: Date.now(),
        })
      ])
    })
  }, 2000)
}
```

Remove or gate this behind a flag before production.
  </action>
  <verify>
Build succeeds: `cd frontend && npm run build`
TLComponents merge doesn't break existing toolbar
In development: debug cursor appears as a dot (not default arrow)
  </verify>
  <done>
DotCursor renders for all collaborator cursors.
Custom cursor integrates cleanly with existing toolbar components.
Cursor dot is visible and username appears on hover.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Type check:** `cd frontend && npx tsc --noEmit`
2. **Build check:** `cd frontend && npm run build`
3. **Visual verification (with debug cursor):**
   - Start dev server: `cd frontend && npm run dev`
   - Open canvas page
   - Wait 2 seconds for debug cursor to appear
   - Cursor should be a colored dot, not an arrow
   - Hover over dot to see username label
4. **Code review:**
   - DotCursor uses rounded div (borderRadius: 50%)
   - Size adjusts inversely with zoom
   - Username hidden by default, shown on hover
   - Components merge preserves toolbar functionality
</verification>

<success_criteria>
- DotCursor renders as 16-20px colored circle
- Username label appears on hover only
- Size stays visually consistent across zoom levels (inverse scaling)
- TLComponents configuration merges cleanly with existing toolbar
- Debug cursor visible in development mode to verify rendering
</success_criteria>

<output>
After completion, create `.planning/phases/07-collaboration-polish/07-02-SUMMARY.md`
</output>
