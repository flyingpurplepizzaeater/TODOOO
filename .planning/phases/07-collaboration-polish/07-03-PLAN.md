---
phase: 07-collaboration-polish
plan: 03
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - frontend/src/components/Canvas/collaboration/PresenceSidebar.tsx
  - frontend/src/components/Canvas/collaboration/CollaboratorItem.tsx
  - frontend/src/components/Canvas/collaboration/useIdleDetection.ts
  - frontend/src/components/Canvas/collaboration/useFollowMode.ts
  - frontend/src/components/Canvas/collaboration/index.ts
  - frontend/src/components/Canvas/Canvas.tsx
autonomous: true

must_haves:
  truths:
    - "User sees a sidebar list of all connected collaborators"
    - "Each collaborator shows avatar placeholder and username with colored border"
    - "Idle users (2min inactive) appear dimmed in the sidebar"
    - "Clicking a collaborator avatar follows their viewport"
    - "Sidebar is collapsed on mobile, expanded on desktop"
  artifacts:
    - path: "frontend/src/components/Canvas/collaboration/PresenceSidebar.tsx"
      provides: "Sidebar component showing online collaborators"
      exports: ["PresenceSidebar"]
    - path: "frontend/src/components/Canvas/collaboration/CollaboratorItem.tsx"
      provides: "Individual collaborator row in sidebar"
      exports: ["CollaboratorItem"]
    - path: "frontend/src/components/Canvas/collaboration/useIdleDetection.ts"
      provides: "Hook for tracking idle status"
      exports: ["useIdleDetection"]
    - path: "frontend/src/components/Canvas/collaboration/useFollowMode.ts"
      provides: "Hook for following another user's viewport"
      exports: ["useFollowMode"]
  key_links:
    - from: "frontend/src/components/Canvas/collaboration/PresenceSidebar.tsx"
      to: "useAwareness.others"
      via: "Map of remote user states"
      pattern: "others\\.forEach|Array\\.from\\(others"
    - from: "frontend/src/components/Canvas/collaboration/useFollowMode.ts"
      to: "editor.startFollowingUser"
      via: "tldraw follow API"
      pattern: "startFollowingUser|stopFollowingUser"
---

<objective>
Create the presence sidebar showing online collaborators with follow mode support.

Purpose: SYNC-02 requires users to see who's online. CONTEXT.md specifies a sidebar layout
with avatar + username, colored borders matching cursor colors, idle dimming after 2min,
and follow mode activated by clicking an avatar.

Output: PresenceSidebar component, idle detection, and viewport following functionality.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-collaboration-polish/07-CONTEXT.md
@.planning/phases/07-collaboration-polish/07-RESEARCH.md
@.planning/phases/07-collaboration-polish/07-01-SUMMARY.md

@frontend/src/components/Canvas/Canvas.tsx
@frontend/src/components/Canvas/collaboration/useAwareness.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create idle detection and follow mode hooks</name>
  <files>
    frontend/src/components/Canvas/collaboration/useIdleDetection.ts
    frontend/src/components/Canvas/collaboration/useFollowMode.ts
    frontend/src/components/Canvas/collaboration/index.ts
  </files>
  <action>
Create utility hooks for idle status tracking and viewport following.

**useIdleDetection.ts:**

Per CONTEXT.md:
- Cursor fades after 30 seconds of inactivity
- User marked as idle in presence panel after 2 minutes
- Instant restore when idle user becomes active again

```typescript
import { useState, useEffect, useCallback, useRef } from 'react'

const CURSOR_FADE_TIMEOUT = 30 * 1000   // 30 seconds
const IDLE_STATUS_TIMEOUT = 120 * 1000  // 2 minutes

interface IdleState {
  cursorFaded: boolean
  isIdle: boolean
}

export function useIdleDetection(
  onCursorFade: () => void,
  onIdleStatusChange: (isIdle: boolean) => void
) {
  const [state, setState] = useState<IdleState>({
    cursorFaded: false,
    isIdle: false
  })

  const cursorTimerRef = useRef<number | null>(null)
  const idleTimerRef = useRef<number | null>(null)

  const resetTimers = useCallback(() => {
    // Clear existing timers
    if (cursorTimerRef.current) clearTimeout(cursorTimerRef.current)
    if (idleTimerRef.current) clearTimeout(idleTimerRef.current)

    // Instant restore if was idle
    if (state.cursorFaded || state.isIdle) {
      setState({ cursorFaded: false, isIdle: false })
      onIdleStatusChange(false)
    }

    // Set new timers
    cursorTimerRef.current = window.setTimeout(() => {
      setState(s => ({ ...s, cursorFaded: true }))
      onCursorFade()
    }, CURSOR_FADE_TIMEOUT)

    idleTimerRef.current = window.setTimeout(() => {
      setState(s => ({ ...s, isIdle: true }))
      onIdleStatusChange(true)
    }, IDLE_STATUS_TIMEOUT)
  }, [onCursorFade, onIdleStatusChange, state.cursorFaded, state.isIdle])

  // Clean up on unmount
  useEffect(() => {
    return () => {
      if (cursorTimerRef.current) clearTimeout(cursorTimerRef.current)
      if (idleTimerRef.current) clearTimeout(idleTimerRef.current)
    }
  }, [])

  return { ...state, resetTimers }
}
```

**useFollowMode.ts:**

Per CONTEXT.md:
- Follow mode: click avatar in presence panel to follow their viewport
- Following indicated by: toast notification on start + colored border around viewport
- Stop following: pan/zoom manually OR click explicit button

```typescript
import { useState, useCallback, useEffect } from 'react'
import { Editor } from 'tldraw'

interface FollowState {
  isFollowing: boolean
  followingUserId: string | null
  followingUserName: string | null
  followingUserColor: string | null
}

export function useFollowMode(editor: Editor | null) {
  const [followState, setFollowState] = useState<FollowState>({
    isFollowing: false,
    followingUserId: null,
    followingUserName: null,
    followingUserColor: null
  })

  const startFollowing = useCallback((userId: string, userName: string, color: string) => {
    if (!editor) return

    // tldraw has built-in follow functionality
    editor.startFollowingUser(userId)

    setFollowState({
      isFollowing: true,
      followingUserId: userId,
      followingUserName: userName,
      followingUserColor: color
    })

    // Show toast notification (simple alert for now, can enhance later)
    // Could use a toast library like sonner
    console.log(`Now following ${userName}`)
  }, [editor])

  const stopFollowing = useCallback(() => {
    if (!editor) return

    editor.stopFollowingUser()

    setFollowState({
      isFollowing: false,
      followingUserId: null,
      followingUserName: null,
      followingUserColor: null
    })
  }, [editor])

  // Stop following when user manually pans/zooms
  useEffect(() => {
    if (!editor || !followState.isFollowing) return

    const handleCameraChange = () => {
      // Check if this was a manual camera change (not from following)
      // tldraw automatically handles this, but we need to update our state
      const isFollowing = editor.getIsFollowingUser()
      if (!isFollowing && followState.isFollowing) {
        setFollowState({
          isFollowing: false,
          followingUserId: null,
          followingUserName: null,
          followingUserColor: null
        })
      }
    }

    const unsub = editor.store.listen(handleCameraChange, { source: 'user' })
    return unsub
  }, [editor, followState.isFollowing])

  return { ...followState, startFollowing, stopFollowing }
}
```

Update barrel export in index.ts.
  </action>
  <verify>
TypeScript compiles: `cd frontend && npx tsc --noEmit`
Hooks export correctly
  </verify>
  <done>
useIdleDetection tracks 30s cursor fade and 2min idle status.
useFollowMode wraps tldraw's follow API with state tracking.
Timers clean up properly on unmount.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create CollaboratorItem and PresenceSidebar components</name>
  <files>
    frontend/src/components/Canvas/collaboration/CollaboratorItem.tsx
    frontend/src/components/Canvas/collaboration/PresenceSidebar.tsx
    frontend/src/components/Canvas/collaboration/index.ts
  </files>
  <action>
Create the sidebar UI components for showing online collaborators.

**CollaboratorItem.tsx:**

```typescript
import { AwarenessState } from './types'

interface CollaboratorItemProps {
  state: AwarenessState
  isIdle: boolean
  onFollow: () => void
}

export function CollaboratorItem({ state, isIdle, onFollow }: CollaboratorItemProps) {
  const { user } = state

  return (
    <div
      onClick={onFollow}
      style={{
        display: 'flex',
        alignItems: 'center',
        gap: 10,
        padding: '8px 12px',
        cursor: 'pointer',
        borderRadius: 6,
        transition: 'background 0.15s',
        opacity: isIdle ? 0.5 : 1,  // Dimmed when idle per CONTEXT.md
      }}
      onMouseEnter={(e) => (e.currentTarget.style.background = '#f3f4f6')}
      onMouseLeave={(e) => (e.currentTarget.style.background = 'transparent')}
      title={isIdle ? `${user.name} (idle)` : `Click to follow ${user.name}`}
    >
      {/* Avatar placeholder with colored border per CONTEXT.md */}
      <div
        style={{
          width: 32,
          height: 32,
          borderRadius: '50%',
          border: `3px solid ${user.color}`,
          background: '#e5e7eb',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          fontSize: 14,
          fontWeight: 600,
          color: '#6b7280',
          fontFamily: 'system-ui, sans-serif',
        }}
      >
        {/* First letter of name as avatar placeholder */}
        {user.name.charAt(0).toUpperCase()}
      </div>

      {/* Username */}
      <div style={{ flex: 1, minWidth: 0 }}>
        <div
          style={{
            fontSize: 13,
            fontWeight: 500,
            color: '#374151',
            fontFamily: 'system-ui, sans-serif',
            overflow: 'hidden',
            textOverflow: 'ellipsis',
            whiteSpace: 'nowrap',
          }}
        >
          {user.name}
        </div>
        {isIdle && (
          <div
            style={{
              fontSize: 11,
              color: '#9ca3af',
              fontFamily: 'system-ui, sans-serif',
            }}
          >
            Idle
          </div>
        )}
      </div>
    </div>
  )
}
```

**PresenceSidebar.tsx:**

Per CONTEXT.md:
- Sidebar layout (not floating panel)
- Adaptive default: collapsed on mobile, open on desktop

```typescript
import { useState, useEffect } from 'react'
import { AwarenessState } from './types'
import { CollaboratorItem } from './CollaboratorItem'

interface PresenceSidebarProps {
  others: Map<number, AwarenessState>
  onFollowUser: (userId: string, userName: string, color: string) => void
  followingUserId: string | null
  followingUserColor: string | null
}

const MOBILE_BREAKPOINT = 768

export function PresenceSidebar({
  others,
  onFollowUser,
  followingUserId,
  followingUserColor
}: PresenceSidebarProps) {
  // Responsive: collapsed on mobile, open on desktop
  const [isOpen, setIsOpen] = useState(() => window.innerWidth >= MOBILE_BREAKPOINT)
  const [isMobile, setIsMobile] = useState(() => window.innerWidth < MOBILE_BREAKPOINT)

  // Handle window resize
  useEffect(() => {
    const handleResize = () => {
      const mobile = window.innerWidth < MOBILE_BREAKPOINT
      setIsMobile(mobile)
      // Auto-collapse on mobile, auto-open on desktop
      if (mobile && !isMobile) setIsOpen(false)
      if (!mobile && isMobile) setIsOpen(true)
    }

    window.addEventListener('resize', handleResize)
    return () => window.removeEventListener('resize', handleResize)
  }, [isMobile])

  const collaborators = Array.from(others.entries())
  const onlineCount = collaborators.length

  // Determine if user is idle (check lastActivity > 2min ago)
  const isUserIdle = (state: AwarenessState) => {
    return state.isIdle || (Date.now() - state.lastActivity > 120000)
  }

  return (
    <>
      {/* Following indicator border per CONTEXT.md */}
      {followingUserId && followingUserColor && (
        <div
          style={{
            position: 'fixed',
            inset: 4,
            border: `3px solid ${followingUserColor}`,
            borderRadius: 8,
            pointerEvents: 'none',
            zIndex: 400,
          }}
        />
      )}

      {/* Sidebar */}
      <div
        style={{
          position: 'fixed',
          top: 60,  // Below connection indicator
          right: isOpen ? 0 : -240,
          width: 240,
          maxHeight: 'calc(100vh - 140px)',
          background: 'rgba(255, 255, 255, 0.95)',
          borderRadius: '8px 0 0 8px',
          boxShadow: '-2px 0 8px rgba(0, 0, 0, 0.1)',
          zIndex: 350,
          transition: 'right 0.2s ease-in-out',
          display: 'flex',
          flexDirection: 'column',
          fontFamily: 'system-ui, sans-serif',
        }}
      >
        {/* Header */}
        <div
          style={{
            padding: '12px 16px',
            borderBottom: '1px solid #e5e7eb',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'space-between',
          }}
        >
          <span style={{ fontSize: 13, fontWeight: 600, color: '#374151' }}>
            Online ({onlineCount})
          </span>
          {followingUserId && (
            <button
              onClick={() => onFollowUser('', '', '')}  // Empty stops following
              style={{
                fontSize: 11,
                color: '#6366f1',
                background: 'transparent',
                border: 'none',
                cursor: 'pointer',
                fontFamily: 'system-ui, sans-serif',
              }}
            >
              Stop Following
            </button>
          )}
        </div>

        {/* Collaborator list */}
        <div
          style={{
            flex: 1,
            overflowY: 'auto',
            padding: '8px 4px',
          }}
        >
          {collaborators.length === 0 ? (
            <div
              style={{
                padding: '20px 12px',
                textAlign: 'center',
                fontSize: 12,
                color: '#9ca3af',
              }}
            >
              No other collaborators
            </div>
          ) : (
            collaborators.map(([clientId, state]) => (
              <CollaboratorItem
                key={clientId}
                state={state}
                isIdle={isUserIdle(state)}
                onFollow={() => onFollowUser(state.user.id, state.user.name, state.user.color)}
              />
            ))
          )}
        </div>
      </div>

      {/* Toggle button - visible on both mobile and desktop */}
      <button
        onClick={() => setIsOpen(!isOpen)}
        style={{
          position: 'fixed',
          top: 60,
          right: isOpen ? 240 : 0,
          width: 28,
          height: 40,
          background: 'rgba(255, 255, 255, 0.95)',
          border: 'none',
          borderRadius: '4px 0 0 4px',
          boxShadow: '-2px 0 8px rgba(0, 0, 0, 0.1)',
          cursor: 'pointer',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          zIndex: 351,
          transition: 'right 0.2s ease-in-out',
          color: '#6b7280',
        }}
        title={isOpen ? 'Hide collaborators' : 'Show collaborators'}
      >
        {isOpen ? (
          // Right arrow (collapse)
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
            <polyline points="9 18 15 12 9 6" />
          </svg>
        ) : (
          // Badge with count + left arrow
          <>
            <span style={{ fontSize: 11, fontWeight: 600 }}>{onlineCount}</span>
          </>
        )}
      </button>
    </>
  )
}
```

Update barrel export in index.ts.
  </action>
  <verify>
TypeScript compiles: `cd frontend && npx tsc --noEmit`
Components export correctly
Sidebar renders at correct position (right: 0 when open)
  </verify>
  <done>
PresenceSidebar shows list of online collaborators.
CollaboratorItem displays avatar placeholder with colored border.
Idle users are dimmed (opacity 0.5).
Toggle button shows/hides sidebar.
Responsive: collapsed on mobile, open on desktop.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate presence sidebar into Canvas</name>
  <files>
    frontend/src/components/Canvas/Canvas.tsx
  </files>
  <action>
Wire the PresenceSidebar and follow mode into the Canvas component.

**Update Canvas.tsx:**

1. **Import new components and hooks:**
```typescript
import { PresenceSidebar, useFollowMode, useIdleDetection } from './collaboration'
```

2. **Initialize follow mode hook:**
```typescript
const followMode = useFollowMode(editor)
```

3. **Initialize idle detection:**
- Connect to awareness to update isIdle flag
- Connect to cursor fade (update awareness cursor to null)

```typescript
const { resetTimers } = useIdleDetection(
  () => {
    // Cursor fade callback - set cursor to null in awareness
    // This will be called from useAwareness integration
  },
  (isIdle) => {
    // Idle status change - update awareness isIdle field
  }
)
```

4. **Call resetTimers on cursor movement:**
- This happens inside useAwareness when cursor updates
- May need to pass resetTimers callback to useAwareness

5. **Handle follow action:**
```typescript
const handleFollowUser = useCallback((userId: string, userName: string, color: string) => {
  if (!userId) {
    followMode.stopFollowing()
  } else {
    followMode.startFollowing(userId, userName, color)
  }
}, [followMode])
```

6. **Render PresenceSidebar:**
```tsx
{editor && others && (
  <PresenceSidebar
    others={others}
    onFollowUser={handleFollowUser}
    followingUserId={followMode.followingUserId}
    followingUserColor={followMode.followingUserColor}
  />
)}
```

7. **Position sidebar correctly:**
- Sidebar at top: 60 is below ConnectionIndicator
- Make sure it doesn't overlap with UndoRedoIndicator (bottom-right)

8. **Ensure awareness 'others' is passed to sidebar:**
- useAwareness returns `others` Map
- Pass to PresenceSidebar for rendering

**Integration flow:**
```
useAwareness -> others Map -> PresenceSidebar -> CollaboratorItem
                                              -> onFollow -> useFollowMode.startFollowing
```
  </action>
  <verify>
Build succeeds: `cd frontend && npm run build`
Sidebar renders on right side of canvas
Toggle button shows/hides sidebar
Following border appears when following (with debug user if testing)
  </verify>
  <done>
PresenceSidebar appears on right side of canvas.
Toggle button works on mobile and desktop.
Click on collaborator triggers follow mode.
Stop Following button in header stops following.
Colored border appears around viewport when following.
Idle detection resets on user activity.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Type check:** `cd frontend && npx tsc --noEmit`
2. **Build check:** `cd frontend && npm run build`
3. **Visual verification:**
   - Start dev server: `cd frontend && npm run dev`
   - Sidebar should appear on right side
   - Toggle button should show/hide sidebar
   - "Online (0)" header when no collaborators
   - With debug cursor from Plan 02, user should appear in sidebar
4. **Responsive check:**
   - Resize browser to mobile width (<768px)
   - Sidebar should auto-collapse
   - Expand to desktop width
   - Sidebar should auto-open
5. **Code review:**
   - Idle detection uses 30s/2min timeouts
   - Follow mode wraps tldraw API
   - Sidebar renders collaborators with colored borders
   - Stop Following button clears follow state
</verification>

<success_criteria>
- PresenceSidebar shows online count in header
- CollaboratorItem shows avatar placeholder with user's cursor color border
- Idle users (2min+) appear dimmed
- Click triggers follow mode with colored viewport border
- Stop Following button in header ends follow mode
- Sidebar collapses on mobile (<768px), expands on desktop
- Toggle button works correctly
</success_criteria>

<output>
After completion, create `.planning/phases/07-collaboration-polish/07-03-SUMMARY.md`
</output>
