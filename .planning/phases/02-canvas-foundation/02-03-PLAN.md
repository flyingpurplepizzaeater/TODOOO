---
phase: 02-canvas-foundation
plan: 03
type: execute
wave: 3
depends_on: ["02-02"]
files_modified:
  - frontend/src/components/Canvas/Canvas.tsx
  - frontend/src/components/Canvas/cameraOptions.ts
  - frontend/src/components/Canvas/uiOverrides.ts
autonomous: true

must_haves:
  truths:
    - "User can pan canvas by clicking and dragging"
    - "User can zoom with Ctrl+scroll between 10% and 400%"
    - "User can zoom with bracket keys [ and ]"
    - "User can undo with Ctrl+Z (global, affects all changes)"
    - "User can redo with Ctrl+Shift+Z"
    - "Delete/Backspace removes selected objects"
    - "Toolbar shows zoom percentage and +/- buttons"
  artifacts:
    - path: "frontend/src/components/Canvas/cameraOptions.ts"
      provides: "Camera configuration (zoom limits, behavior)"
      exports: ["cameraOptions"]
    - path: "frontend/src/components/Canvas/uiOverrides.ts"
      provides: "Keyboard shortcut customizations"
      exports: ["uiOverrides"]
  key_links:
    - from: "frontend/src/components/Canvas/Canvas.tsx"
      to: "frontend/src/components/Canvas/cameraOptions.ts"
      via: "cameraOptions prop"
      pattern: "cameraOptions"
    - from: "frontend/src/components/Canvas/Canvas.tsx"
      to: "frontend/src/components/Canvas/uiOverrides.ts"
      via: "overrides prop"
      pattern: "overrides"
---

<objective>
Customize tldraw camera, toolbar, and keyboard shortcuts per user requirements.

Purpose: Users expect specific navigation feel (direct pan, Ctrl+zoom) and extended shortcuts (bracket keys for zoom, number keys for tools). This plan configures tldraw to match the decisions from 02-CONTEXT.md.

Output: Customized tldraw canvas with correct camera behavior, zoom limits, and keyboard shortcuts.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-canvas-foundation/02-CONTEXT.md
@.planning/phases/02-canvas-foundation/02-RESEARCH.md
@.planning/phases/02-canvas-foundation/02-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure camera options</name>
  <files>frontend/src/components/Canvas/cameraOptions.ts</files>
  <action>
Create camera configuration matching user requirements from CONTEXT.md:

Create frontend/src/components/Canvas/cameraOptions.ts:
```typescript
import { TLCameraOptions } from 'tldraw'

/**
 * Camera configuration for CollabBoard canvas.
 *
 * User requirements (from 02-CONTEXT.md):
 * - Direct 1:1 pan tracking (no inertia/momentum) - default tldraw behavior
 * - Zoom limits: 10% to 400%
 * - Zoom triggered by Ctrl+scroll only - NOTE: tldraw wheelBehavior is global,
 *   implementing Ctrl-only requires custom event handling (see handleWheel)
 * - Corner minimap for large boards - built into tldraw navigation panel
 */
export const cameraOptions: TLCameraOptions = {
  // Zoom behavior - 'zoom' means scroll wheel zooms
  // Note: tldraw doesn't natively support "Ctrl+scroll only"
  // We handle this with a custom wheel event handler
  wheelBehavior: 'zoom',

  // Pan and zoom speed (1 = default, 0-2 range)
  panSpeed: 1,
  zoomSpeed: 1,

  // Zoom steps define allowed zoom levels
  // First value = minimum (10%), last value = maximum (400%)
  zoomSteps: [0.1, 0.25, 0.5, 0.75, 1, 1.5, 2, 3, 4],

  // Don't lock camera movement
  isLocked: false,
}

/**
 * Custom wheel event handler to implement Ctrl+scroll only zoom.
 * Regular scroll should do nothing (page doesn't scroll within tldraw).
 *
 * Usage: Apply to tldraw container div's onWheel event
 */
export function handleWheel(e: WheelEvent, editor: any) {
  // Only zoom if Ctrl (or Cmd on Mac) is pressed
  if (!e.ctrlKey && !e.metaKey) {
    e.preventDefault()
    e.stopPropagation()
    return
  }
  // Otherwise, let tldraw handle it (zoom)
}
```

Key decisions:
- zoomSteps [0.1...4] = 10% to 400% zoom range
- wheelBehavior 'zoom' + custom handler = Ctrl+scroll only
- panSpeed/zoomSpeed at 1 = direct 1:1 tracking feel
  </action>
  <verify>
- cameraOptions.ts exports cameraOptions constant
- zoomSteps array starts with 0.1 and ends with 4
- `npx tsc --noEmit` passes
  </verify>
  <done>
Camera options configured with 10%-400% zoom range and direct pan tracking.
  </done>
</task>

<task type="auto">
  <name>Task 2: Configure keyboard shortcut overrides</name>
  <files>frontend/src/components/Canvas/uiOverrides.ts</files>
  <action>
Create keyboard shortcut overrides matching user requirements:

Create frontend/src/components/Canvas/uiOverrides.ts:
```typescript
import { TLUiOverrides, TLUiActionsContextType, TLUiToolsContextType } from 'tldraw'

/**
 * UI overrides for CollabBoard canvas.
 *
 * User requirements (from 02-CONTEXT.md):
 * - Standard: Ctrl+Z/Y, Delete, Ctrl+A, Ctrl+C/V, Space to pan
 * - Extended: number keys for tools, bracket keys for zoom
 * - Delete via Delete/Backspace key
 *
 * tldraw already provides most standard shortcuts. We customize:
 * - Bracket keys [ ] for zoom in/out
 * - Number keys 1-5 for common tools
 */
export const uiOverrides: TLUiOverrides = {
  actions(_editor, actions): TLUiActionsContextType {
    return {
      ...actions,
      // Bracket keys for zoom (in addition to +/- which tldraw provides)
      'zoom-in': {
        ...actions['zoom-in'],
        kbd: ']=,shift+=' // ] and = (same key, shift for +)
      },
      'zoom-out': {
        ...actions['zoom-out'],
        kbd: '[-' // [ and -
      },
    }
  },

  tools(_editor, tools): TLUiToolsContextType {
    return {
      ...tools,
      // Number keys for tools (1=select, 2=draw, 3=eraser, 4=arrow, 5=rectangle)
      // Note: These will be useful in Phase 3 when drawing tools are enabled
      select: { ...tools.select, kbd: '1,v' },
      draw: { ...tools.draw, kbd: '2,p' },
      eraser: { ...tools.eraser, kbd: '3,e' },
      arrow: { ...tools.arrow, kbd: '4,a' },
      geo: { ...tools.geo, kbd: '5,r' },
    }
  },
}

/**
 * Default shortcuts provided by tldraw (no override needed):
 *
 * Navigation:
 * - Space + drag: Pan canvas
 * - Scroll wheel (with our Ctrl requirement): Zoom
 * - Ctrl+0: Zoom to 100%
 * - Ctrl+1: Zoom to fit
 * - Ctrl+2: Zoom to selection
 *
 * Selection & Editing:
 * - Ctrl+A: Select all
 * - Ctrl+C: Copy
 * - Ctrl+V: Paste
 * - Ctrl+X: Cut
 * - Ctrl+D: Duplicate
 * - Delete/Backspace: Delete selected
 * - Escape: Deselect / cancel
 *
 * History:
 * - Ctrl+Z: Undo
 * - Ctrl+Shift+Z / Ctrl+Y: Redo
 *
 * Multi-select:
 * - Shift+click: Add to selection
 * - Click empty: Deselect all
 */
```

The overrides add bracket keys and number keys while preserving all tldraw defaults.
  </action>
  <verify>
- uiOverrides.ts exports uiOverrides constant
- `npx tsc --noEmit` passes
  </verify>
  <done>
Keyboard shortcuts configured with bracket keys for zoom and number keys for tools.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate options into Canvas component</name>
  <files>frontend/src/components/Canvas/Canvas.tsx</files>
  <action>
Update Canvas.tsx to use camera options and UI overrides:

Update frontend/src/components/Canvas/Canvas.tsx:
```typescript
import { useCallback, useRef } from 'react'
import { Tldraw, Editor } from 'tldraw'
import 'tldraw/tldraw.css'
import { useYjsStore, ConnectionStatus } from './useYjsStore'
import { cameraOptions, handleWheel } from './cameraOptions'
import { uiOverrides } from './uiOverrides'

interface CanvasProps {
  boardId: string
  token: string
}

function ConnectionIndicator({ status }: { status: ConnectionStatus }) {
  const statusColors = {
    connecting: '#f59e0b',
    connected: '#22c55e',
    disconnected: '#ef4444',
    error: '#ef4444',
  }

  const statusLabels = {
    connecting: 'Connecting...',
    connected: 'Connected',
    disconnected: 'Disconnected',
    error: 'Connection Error',
  }

  return (
    <div style={{
      position: 'absolute',
      top: 8,
      right: 8,
      zIndex: 1000,
      display: 'flex',
      alignItems: 'center',
      gap: 6,
      padding: '4px 8px',
      borderRadius: 4,
      background: 'rgba(255,255,255,0.9)',
      fontSize: 12,
    }}>
      <div style={{
        width: 8,
        height: 8,
        borderRadius: '50%',
        background: statusColors[status],
      }} />
      {statusLabels[status]}
    </div>
  )
}

export function Canvas({ boardId, token }: CanvasProps) {
  const { store, status } = useYjsStore(boardId, token)
  const editorRef = useRef<Editor | null>(null)
  const containerRef = useRef<HTMLDivElement>(null)

  // Handle editor mount - enable snap mode and store reference
  const handleMount = useCallback((editor: Editor) => {
    editorRef.current = editor

    // Enable snap mode (grid + object snapping) per CONTEXT.md
    editor.user.updateUserPreferences({ isSnapMode: true })
  }, [])

  // Custom wheel handler for Ctrl+scroll only zoom
  const onWheel = useCallback((e: React.WheelEvent) => {
    if (editorRef.current) {
      handleWheel(e.nativeEvent, editorRef.current)
    }
  }, [])

  return (
    <div
      ref={containerRef}
      style={{ position: 'fixed', inset: 0 }}
      onWheel={onWheel}
    >
      <ConnectionIndicator status={status} />
      <Tldraw
        store={store}
        cameraOptions={cameraOptions}
        overrides={uiOverrides}
        onMount={handleMount}
        autoFocus
      />
    </div>
  )
}
```

Key integrations:
- cameraOptions prop sets zoom limits and behavior
- overrides prop customizes keyboard shortcuts
- onMount enables snap mode for grid + object alignment
- onWheel intercepts scroll to implement Ctrl-only zoom
  </action>
  <verify>
1. Run `npm run dev` and test with valid token:
   - Ctrl+scroll zooms (regular scroll should not zoom)
   - Press [ to zoom out, ] to zoom in
   - Press 1 to select tool, 2 for draw (if available)
   - Ctrl+Z undoes, Ctrl+Shift+Z redoes
   - Delete key removes selected objects
   - Shift+click adds to selection
   - Objects snap to grid when moving

2. TypeScript check:
   - `npx tsc --noEmit` passes
  </verify>
  <done>
Canvas component updated with camera options, keyboard shortcuts, and snap mode enabled.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Files exist:
   - frontend/src/components/Canvas/cameraOptions.ts
   - frontend/src/components/Canvas/uiOverrides.ts
   - frontend/src/components/Canvas/Canvas.tsx (updated)

2. Type check passes:
   - `cd frontend && npx tsc --noEmit`

3. Functional verification (with valid token and backend):
   - Zoom range limited to 10%-400%
   - Bracket keys zoom in/out
   - Ctrl+scroll zooms, regular scroll does nothing
   - Ctrl+Z/Ctrl+Shift+Z work for undo/redo
   - Delete removes selected objects
   - Objects snap when moved
</verification>

<success_criteria>
- Camera options configured with 10%-400% zoom
- Keyboard shortcuts include bracket keys and number keys
- Ctrl+scroll only zoom implemented
- Snap mode enabled by default
- All standard shortcuts (Ctrl+Z, Delete, etc.) work
</success_criteria>

<output>
After completion, create `.planning/phases/02-canvas-foundation/02-03-SUMMARY.md`
</output>
