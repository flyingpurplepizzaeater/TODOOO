---
phase: 01-real-time-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - models.py
  - alembic/versions/002_canvas_boards.py
  - schemas.py
autonomous: true

must_haves:
  truths:
    - "Board model exists with id, owner_id, title, is_public, created_at"
    - "BoardPermission model exists with board_id, user_id, level, created_at"
    - "AuditLog model exists with user_id, board_id, action, permission_level, timestamp"
    - "Database migration creates all three tables"
  artifacts:
    - path: "models.py"
      provides: "Board, BoardPermission, AuditLog, PermissionLevel enum"
      contains: "class Board"
    - path: "alembic/versions/002_canvas_boards.py"
      provides: "Migration for boards, board_permissions, audit_logs tables"
      contains: "def upgrade"
    - path: "schemas.py"
      provides: "Pydantic schemas for board operations"
      contains: "class BoardCreate"
  key_links:
    - from: "models.py"
      to: "database.py"
      via: "Base import"
      pattern: "from database import Base"
    - from: "alembic/versions/002_canvas_boards.py"
      to: "models.py"
      via: "table definitions match models"
      pattern: "op.create_table"
---

<objective>
Create database models and migrations for canvas boards, permissions, and audit logging.

Purpose: Establishes the data foundation for board ownership, sharing permissions, and access tracking required by SYNC-04 (shareable links) and CONTEXT.md decisions.

Output: Three new SQLAlchemy models (Board, BoardPermission, AuditLog), PermissionLevel enum, Pydantic schemas, and Alembic migration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-real-time-infrastructure/01-CONTEXT.md
@.planning/phases/01-real-time-infrastructure/01-RESEARCH.md

# Existing codebase patterns
@models.py
@schemas.py
@database.py
@alembic/versions/001_initial_schema.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Board, BoardPermission, AuditLog models and PermissionLevel enum</name>
  <files>models.py</files>
  <action>
Add to models.py:

1. PermissionLevel enum (str, Enum) with values: VIEW = "view", COMMENT = "comment", EDIT = "edit"

2. Board model:
   - id: String(36), primary_key (UUID stored as string for SQLite compatibility)
   - owner_id: Integer, ForeignKey("users.id"), nullable=False
   - title: String(200), nullable=False, default="Untitled Board"
   - is_public: Boolean, default=False
   - created_at: DateTime, default=datetime.utcnow
   - Relationship: owner = relationship("User")
   - Relationship: permissions = relationship("BoardPermission", back_populates="board", cascade="all, delete-orphan")

3. BoardPermission model:
   - id: Integer, primary_key
   - board_id: String(36), ForeignKey("boards.id"), nullable=False
   - user_id: Integer, ForeignKey("users.id"), nullable=True (NULL for public access)
   - level: Enum(PermissionLevel), nullable=False
   - created_at: DateTime, default=datetime.utcnow
   - Relationship: board = relationship("Board", back_populates="permissions")
   - Relationship: user = relationship("User")
   - Unique constraint on (board_id, user_id) to prevent duplicate permissions

4. AuditLog model:
   - id: Integer, primary_key
   - user_id: Integer, ForeignKey("users.id"), nullable=True (NULL for anonymous)
   - board_id: String(36), ForeignKey("boards.id"), nullable=False
   - action: String(50), nullable=False (values: "access", "permission_change", "create", "delete")
   - permission_level: String(20), nullable=True
   - ip_address: String(45), nullable=True (IPv6 length)
   - user_agent: String(500), nullable=True
   - timestamp: DateTime, default=datetime.utcnow, index=True

Follow existing model patterns: use Column imports, relationship patterns from User/Team/TodoItem models.
  </action>
  <verify>
python -c "from models import Board, BoardPermission, AuditLog, PermissionLevel; print('Models imported successfully')"
  </verify>
  <done>
Board, BoardPermission, AuditLog models and PermissionLevel enum import without errors. All fields and relationships defined as specified.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Pydantic schemas for board operations</name>
  <files>schemas.py</files>
  <action>
Add to schemas.py:

1. BoardCreate schema:
   - title: str = "Untitled Board"
   - is_public: bool = False

2. BoardResponse schema:
   - id: str
   - owner_id: int
   - title: str
   - is_public: bool
   - created_at: datetime
   - Config: from_attributes = True (for ORM mode)

3. BoardPermissionCreate schema:
   - user_id: int | None = None (None for public permission)
   - level: str (validate against "view", "comment", "edit")

4. BoardPermissionResponse schema:
   - id: int
   - board_id: str
   - user_id: int | None
   - level: str
   - created_at: datetime
   - Config: from_attributes = True

5. ShareLinkResponse schema:
   - board_id: str
   - url: str
   - permission_level: str
   - is_public: bool

Import datetime if not already imported. Follow existing schema patterns (BaseModel, Field validators).
  </action>
  <verify>
python -c "from schemas import BoardCreate, BoardResponse, BoardPermissionCreate, BoardPermissionResponse, ShareLinkResponse; print('Schemas imported successfully')"
  </verify>
  <done>
All board-related Pydantic schemas import without errors and have correct field definitions.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Alembic migration for canvas tables</name>
  <files>alembic/versions/002_canvas_boards.py</files>
  <action>
Create new migration file alembic/versions/002_canvas_boards.py:

1. Set revision id (generate with secrets.token_hex(6))
2. Set down_revision to the ID from 001_initial_schema.py
3. Import op and sa from alembic

4. upgrade() function creates:
   - boards table: id (String 36, PK), owner_id (Integer, FK users.id), title (String 200), is_public (Boolean), created_at (DateTime)
   - board_permissions table: id (Integer, PK), board_id (String 36, FK boards.id), user_id (Integer nullable, FK users.id), level (String 20), created_at (DateTime)
   - Add unique constraint on board_permissions(board_id, user_id)
   - audit_logs table: id (Integer, PK), user_id (Integer nullable), board_id (String 36), action (String 50), permission_level (String 20 nullable), ip_address (String 45 nullable), user_agent (String 500 nullable), timestamp (DateTime, index=True)

5. downgrade() function drops tables in reverse order: audit_logs, board_permissions, boards

Use op.create_table, op.create_index, op.create_unique_constraint patterns. Match existing migration style from 001_initial_schema.py.
  </action>
  <verify>
cd "C:\Users\Workshop\Desktop\AI-2\Claude RW+skills\TODO" && python -m alembic upgrade head
  </verify>
  <done>
Migration runs successfully. All three tables exist in database with correct columns and constraints.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `python -c "from models import Board, BoardPermission, AuditLog, PermissionLevel"` succeeds
2. `python -c "from schemas import BoardCreate, BoardResponse, BoardPermissionCreate, BoardPermissionResponse, ShareLinkResponse"` succeeds
3. `alembic upgrade head` runs without errors
4. Database contains boards, board_permissions, audit_logs tables
</verification>

<success_criteria>
- Board model has id, owner_id, title, is_public, created_at fields
- BoardPermission model has board_id, user_id, level with unique constraint
- AuditLog model has user_id, board_id, action, permission_level, ip_address, user_agent, timestamp
- PermissionLevel enum has VIEW, COMMENT, EDIT values
- All Pydantic schemas validate correctly
- Migration applies cleanly to existing database
</success_criteria>

<output>
After completion, create `.planning/phases/01-real-time-infrastructure/01-01-SUMMARY.md`
</output>
