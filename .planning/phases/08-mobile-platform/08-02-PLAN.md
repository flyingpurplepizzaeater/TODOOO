---
phase: 08-mobile-platform
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/components/Canvas/cameraOptions.ts
  - frontend/src/components/Canvas/touchConfig.ts
  - frontend/src/components/Canvas/Canvas.tsx
autonomous: true

must_haves:
  truths:
    - "Pinch-to-zoom works on mobile devices"
    - "One-finger drawing works in draw mode"
    - "Two-finger pan works on mobile"
    - "Desktop Ctrl+scroll zoom still works"
    - "Stylus pressure affects stroke width"
  artifacts:
    - path: "frontend/src/components/Canvas/touchConfig.ts"
      provides: "Touch gesture configuration"
      exports: ["isTouchDevice", "supportsStylus"]
    - path: "frontend/src/components/Canvas/cameraOptions.ts"
      provides: "Updated wheel handler for mobile compatibility"
      exports: ["handleWheel"]
    - path: "frontend/src/components/Canvas/Canvas.tsx"
      provides: "Mobile-aware canvas with forceMobile prop"
      contains: "forceMobile"
  key_links:
    - from: "frontend/src/components/Canvas/Canvas.tsx"
      to: "frontend/src/components/Canvas/touchConfig.ts"
      via: "import isTouchDevice"
      pattern: "import.*touchConfig"
    - from: "frontend/src/components/Canvas/cameraOptions.ts"
      to: "touchConfig.ts"
      via: "touch detection in wheel handler"
      pattern: "isTouchDevice"
---

<objective>
Configure touch gestures for mobile canvas interaction.

Purpose: Enables natural mobile interactions - pinch-to-zoom, finger drawing, and stylus support. This is the core UX for PLAT-04 (touch gestures work).

Output: Mobile-responsive canvas that handles touch/stylus input while preserving desktop behavior.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-mobile-platform/08-CONTEXT.md
@.planning/phases/08-mobile-platform/08-RESEARCH.md
@frontend/src/components/Canvas/Canvas.tsx
@frontend/src/components/Canvas/cameraOptions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create touch configuration module</name>
  <files>frontend/src/components/Canvas/touchConfig.ts</files>
  <action>
Create `frontend/src/components/Canvas/touchConfig.ts`:

```typescript
/**
 * Touch gesture configuration for mobile canvas.
 *
 * CONTEXT.md requirements:
 * - Two-finger pan, one-finger draw (default draw mode)
 * - Stylus pressure sensitivity for stroke width
 * - Stylus draws while finger pans
 * - Long-press: context menu for shapes, edit for text
 *
 * tldraw natively handles most touch via useGestureEvents hook:
 * - Pinch-to-zoom: Built-in
 * - Two-finger pan: Built-in
 * - One-finger draw: Default in draw tool
 * - Stylus pressure: Automatic detection
 */

/**
 * Returns true if device supports touch input.
 * Used to conditionally adjust behavior for touch vs mouse.
 */
export function isTouchDevice(): boolean {
  return 'ontouchstart' in window || navigator.maxTouchPoints > 0;
}

/**
 * Returns true if device supports pressure-sensitive input (stylus).
 * Checks for PointerEvent pressure property support.
 */
export function supportsStylus(): boolean {
  return 'PointerEvent' in window && navigator.maxTouchPoints > 0;
}

/**
 * Returns true if we're likely on a mobile device.
 * More aggressive than isTouchDevice - also checks screen size.
 */
export function isMobileViewport(): boolean {
  return window.innerWidth <= 768 || isTouchDevice();
}

/**
 * Detect if pointer event is from stylus (pen/pencil).
 * Used to differentiate stylus input from finger touch.
 */
export function isStylusEvent(e: PointerEvent): boolean {
  return e.pointerType === 'pen';
}

/**
 * Get pressure value from pointer event.
 * Returns 0.5 (medium) for non-pressure devices.
 * Stylus devices return actual pressure (0-1).
 */
export function getPointerPressure(e: PointerEvent): number {
  // pointerType 'pen' indicates stylus
  if (e.pointerType === 'pen' && e.pressure > 0) {
    return e.pressure;
  }
  // Default pressure for finger/mouse
  return 0.5;
}

/**
 * Long-press duration in milliseconds.
 * Per CONTEXT.md: long-press shows context menu for shapes, edit for text.
 */
export const LONG_PRESS_DURATION = 500;
```
  </action>
  <verify>
- `cat frontend/src/components/Canvas/touchConfig.ts` shows touch utilities
- TypeScript compiles: `cd frontend && npx tsc --noEmit`
  </verify>
  <done>Touch configuration module created with device detection and stylus support</done>
</task>

<task type="auto">
  <name>Task 2: Update wheel handler for mobile compatibility</name>
  <files>frontend/src/components/Canvas/cameraOptions.ts</files>
  <action>
Update `frontend/src/components/Canvas/cameraOptions.ts` to allow mobile pinch gestures:

```typescript
import { type TLCameraOptions, Editor } from 'tldraw'
import { isTouchDevice } from './touchConfig'

/**
 * Camera configuration for CollabBoard canvas.
 *
 * User requirements (from 02-CONTEXT.md):
 * - Direct 1:1 pan tracking (no inertia/momentum) - default tldraw behavior
 * - Zoom limits: 10% to 400%
 * - Zoom triggered by Ctrl+scroll only on DESKTOP
 * - Mobile: pinch-to-zoom works naturally
 * - Corner minimap for large boards - built into tldraw navigation panel
 */
export const cameraOptions: TLCameraOptions = {
  // Zoom behavior - 'zoom' means scroll wheel zooms
  // Note: On desktop, we use custom wheel handler for Ctrl-only
  // On mobile, tldraw's native pinch-to-zoom takes over
  wheelBehavior: 'zoom',

  // Pan and zoom speed (1 = default, 0-2 range)
  panSpeed: 1,
  zoomSpeed: 1,

  // Zoom steps define allowed zoom levels
  // First value = minimum (10%), last value = maximum (400%)
  zoomSteps: [0.1, 0.25, 0.5, 0.75, 1, 1.5, 2, 3, 4],

  // Don't lock camera movement
  isLocked: false,
}

/**
 * Custom wheel event handler to implement Ctrl+scroll only zoom on DESKTOP.
 * On mobile/touch devices, this handler is bypassed to allow native pinch gestures.
 *
 * RESEARCH.md Pitfall 6: Touch Gestures Conflict with Ctrl+Scroll Zoom
 * - On mobile, pinch events are handled by tldraw's useGestureEvents
 * - This handler only restricts desktop mouse wheel behavior
 *
 * Usage: Apply to tldraw container div's onWheel event
 */
export function handleWheel(e: WheelEvent, _editor: Editor): void {
  // On touch devices, let tldraw handle all gestures natively
  // This allows pinch-to-zoom to work without Ctrl key
  if (isTouchDevice()) {
    return; // Don't prevent default - let tldraw handle it
  }

  // DESKTOP ONLY: Only zoom if Ctrl (or Cmd on Mac) is pressed
  if (!e.ctrlKey && !e.metaKey) {
    e.preventDefault()
    e.stopPropagation()
    return
  }
  // Otherwise, let tldraw handle it (zoom)
}
```

Key changes:
- Import `isTouchDevice` from touchConfig
- Early return for touch devices (allows native pinch-to-zoom)
- Desktop behavior unchanged (Ctrl+scroll only)
  </action>
  <verify>
- `cat frontend/src/components/Canvas/cameraOptions.ts` shows isTouchDevice check
- Import statement includes touchConfig reference
  </verify>
  <done>Wheel handler updated to allow mobile pinch gestures while preserving desktop Ctrl+scroll</done>
</task>

<task type="auto">
  <name>Task 3: Add forceMobile prop and touch awareness to Canvas</name>
  <files>frontend/src/components/Canvas/Canvas.tsx</files>
  <action>
Update `frontend/src/components/Canvas/Canvas.tsx` to add mobile support:

1. Add imports at top:
```typescript
import { isTouchDevice, isMobileViewport } from './touchConfig'
```

2. In the Canvas component, add forceMobile detection:
```typescript
// Detect if we should force mobile UI
// True for native apps (Capacitor) or touch-primary devices
const shouldForceMobile = useMemo(() => {
  // Check for Capacitor native platform
  try {
    const { Capacitor } = require('@capacitor/core');
    if (Capacitor.isNativePlatform()) return true;
  } catch {
    // Capacitor not available (web-only build)
  }
  // Also force mobile UI on touch devices with mobile viewport
  return isTouchDevice() && isMobileViewport();
}, []);
```

3. Add forceMobile prop to Tldraw component:
```tsx
<Tldraw
  store={store}
  shapeUtils={customShapeUtils}
  tools={customTools}
  cameraOptions={cameraOptions}
  overrides={overrides}
  components={canvasComponents}
  onMount={handleMount}
  forceMobile={shouldForceMobile}
  autoFocus
/>
```

4. Update the onWheel handler to respect touch devices:
```typescript
// Custom wheel handler for Ctrl+scroll only zoom (desktop)
// On touch devices, returns early to allow native pinch gestures
const onWheel = useCallback((e: React.WheelEvent) => {
  if (editorRef.current) {
    handleWheel(e.nativeEvent, editorRef.current)
  }
}, [])
```

Full Canvas.tsx updates (only showing changed sections - merge with existing code):

Add to imports section:
```typescript
import { isTouchDevice, isMobileViewport } from './touchConfig'
```

Add after currentUser useMemo (around line 150):
```typescript
// Detect if we should force mobile UI layout
// Forces mobile toolbar and touch-optimized interactions
const shouldForceMobile = useMemo(() => {
  // Check for Capacitor native platform
  try {
    // Dynamic import to avoid build errors when Capacitor not installed
    const Capacitor = (window as unknown as { Capacitor?: { isNativePlatform: () => boolean } }).Capacitor;
    if (Capacitor?.isNativePlatform()) return true;
  } catch {
    // Capacitor not available
  }
  // Force mobile UI on touch devices with mobile viewport
  return isTouchDevice() && isMobileViewport();
}, []);
```

Update Tldraw component props to include forceMobile.
  </action>
  <verify>
- `grep -n "forceMobile" frontend/src/components/Canvas/Canvas.tsx` shows prop usage
- `grep -n "isTouchDevice" frontend/src/components/Canvas/Canvas.tsx` shows import
- `npm run build` completes successfully (verify no import errors)
  </verify>
  <done>Canvas component updated with forceMobile prop and touch-aware wheel handler</done>
</task>

</tasks>

<verification>
1. `cat frontend/src/components/Canvas/touchConfig.ts` exists with exports
2. `cat frontend/src/components/Canvas/cameraOptions.ts` includes isTouchDevice check
3. `grep forceMobile frontend/src/components/Canvas/Canvas.tsx` shows prop
4. `npm run build` completes without errors
5. Web app still works: `npm run dev` and verify Ctrl+scroll zoom on desktop
</verification>

<success_criteria>
- touchConfig.ts provides device detection utilities
- cameraOptions.ts allows native pinch gestures on touch devices
- Canvas.tsx passes forceMobile to tldraw for mobile UI
- Desktop behavior unchanged (Ctrl+scroll zoom)
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/08-mobile-platform/08-02-SUMMARY.md`
</output>
