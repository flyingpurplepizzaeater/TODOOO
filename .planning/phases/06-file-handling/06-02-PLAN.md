---
phase: 06-file-handling
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - frontend/src/components/Canvas/CustomToolbar.tsx
  - frontend/src/components/Canvas/fileHandling/useImageUpload.ts
autonomous: true

must_haves:
  truths:
    - "User can upload images via toolbar button"
    - "User can drag-drop images onto canvas"
    - "User can paste images from clipboard"
    - "Batch uploads cascade with offset"
    - "Images appear at viewport center"
  artifacts:
    - path: "frontend/src/components/Canvas/CustomToolbar.tsx"
      provides: "Image upload button in toolbar"
      contains: "handleImageUpload"
    - path: "frontend/src/components/Canvas/fileHandling/useImageUpload.ts"
      provides: "Image upload logic"
      exports: ["handleFileUpload"]
  key_links:
    - from: "frontend/src/components/Canvas/CustomToolbar.tsx"
      to: "handleFileUpload"
      via: "onClick handler"
      pattern: "handleFileUpload\\(editor\\)"
    - from: "handleFileUpload"
      to: "editor.putExternalContent"
      via: "tldraw API"
      pattern: "putExternalContent"
---

<objective>
Add image upload capabilities to the canvas via toolbar button, drag-drop, and clipboard paste.

Purpose: FILE-01 requires users to be able to add images to the canvas. Three upload methods provide flexibility: explicit button for intentional uploads, drag-drop for quick workflows, paste for screenshots.

Output: Working image upload with all three methods, batch support with cascade layout.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-file-handling/06-RESEARCH.md
@.planning/phases/06-file-handling/06-CONTEXT.md
@.planning/phases/06-file-handling/06-01-SUMMARY.md

# Files to modify
@frontend/src/components/Canvas/CustomToolbar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Image upload utility function</name>
  <files>
    - frontend/src/components/Canvas/fileHandling/useImageUpload.ts
  </files>
  <action>
Create frontend/src/components/Canvas/fileHandling/useImageUpload.ts:

handleFileUpload(editor: Editor): void
- Create hidden input element: type="file", accept="image/*", multiple=true
- On change: process files with cascade offset
- Cascade offset: 40px per image (stacked cards effect per CONTEXT.md)
- Get viewport center using editor.getViewportPageBounds().center
- For each file, call editor.putExternalContent():
  ```typescript
  await editor.putExternalContent({
    type: 'files',
    files: [file],
    point: { x: center.x + i * CASCADE_OFFSET, y: center.y + i * CASCADE_OFFSET },
    ignoreParent: false,
  })
  ```
- Clean up input element after use

NOTE: tldraw handles:
- Drag-drop natively when TLAssetStore is provided (no custom code needed)
- Paste natively when TLAssetStore is provided (no custom code needed)
- The only custom code needed is the toolbar button for explicit file picker

Export handleFileUpload for use in CustomToolbar.
  </action>
  <verify>
- `type frontend\src\components\Canvas\fileHandling\useImageUpload.ts` shows handleFileUpload function
- Function uses editor.putExternalContent with CASCADE_OFFSET
  </verify>
  <done>
handleFileUpload utility ready for toolbar integration. Drag-drop and paste work automatically via tldraw + TLAssetStore.
  </done>
</task>

<task type="auto">
  <name>Task 2: Toolbar image button integration</name>
  <files>
    - frontend/src/components/Canvas/CustomToolbar.tsx
  </files>
  <action>
Update frontend/src/components/Canvas/CustomToolbar.tsx:

1. Import handleFileUpload from './fileHandling/useImageUpload'

2. Add Image button to toolbar (between TODO button and Frames dropdown):
```tsx
{/* Image upload button */}
<button
  onClick={() => handleFileUpload(editor)}
  title="Upload Image"
  style={{
    display: 'flex',
    alignItems: 'center',
    justifyContent: 'center',
    height: 32,
    paddingLeft: 10,
    paddingRight: 10,
    border: 'none',
    borderRadius: 6,
    background: 'rgba(255, 255, 255, 0.9)',
    color: '#444',
    cursor: 'pointer',
    boxShadow: '0 1px 3px rgba(0, 0, 0, 0.1)',
    fontSize: 12,
    fontWeight: 500,
    fontFamily: 'system-ui, sans-serif',
    transition: 'background 0.2s, color 0.2s',
  }}
>
  Image
</button>
```

3. Button styling consistent with existing TODO and Frames buttons
  </action>
  <verify>
- `grep -n "handleFileUpload" frontend/src/components/Canvas/CustomToolbar.tsx` shows import and usage
- `grep -n "Upload Image" frontend/src/components/Canvas/CustomToolbar.tsx` shows button
  </verify>
  <done>
Toolbar has Image button that opens file picker. Batch uploads cascade with 40px offset.
  </done>
</task>

</tasks>

<verification>
1. Toolbar button exists: `grep "Upload Image" frontend/src/components/Canvas/CustomToolbar.tsx`
2. Upload utility exists: `type frontend\src\components\Canvas\fileHandling\useImageUpload.ts`
3. No TypeScript errors: `cd frontend && npm run build 2>&1 | head -20`
</verification>

<success_criteria>
- Image button appears in toolbar
- Clicking Image button opens file picker
- Selected images appear at viewport center with cascade offset
- Drag-drop onto canvas adds images (tldraw built-in + TLAssetStore)
- Paste from clipboard adds images (tldraw built-in + TLAssetStore)
- Multiple images cascade with offset (not overlapping)
</success_criteria>

<output>
After completion, create `.planning/phases/06-file-handling/06-02-SUMMARY.md`
</output>
