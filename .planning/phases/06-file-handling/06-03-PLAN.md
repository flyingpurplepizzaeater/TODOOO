---
phase: 06-file-handling
plan: 03
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - frontend/src/components/Canvas/fileHandling/ExportDialog.tsx
  - frontend/src/components/Canvas/fileHandling/useExport.ts
  - frontend/src/components/Canvas/CustomToolbar.tsx
  - frontend/package.json
autonomous: true

must_haves:
  truths:
    - "User can export board as PNG"
    - "User can export board as PDF"
    - "User can choose viewport only OR full board content"
    - "User can choose background or transparent"
    - "User can choose scale factor (0.5x to 4x)"
    - "PDF supports single page and multi-page layouts"
    - "PDF supports portrait and landscape orientation"
  artifacts:
    - path: "frontend/src/components/Canvas/fileHandling/ExportDialog.tsx"
      provides: "Export options modal"
      exports: ["ExportDialog"]
    - path: "frontend/src/components/Canvas/fileHandling/useExport.ts"
      provides: "PNG and PDF export logic"
      exports: ["exportToPng", "exportToPdf"]
    - path: "frontend/package.json"
      provides: "jspdf dependency"
      contains: "jspdf"
  key_links:
    - from: "frontend/src/components/Canvas/CustomToolbar.tsx"
      to: "ExportDialog"
      via: "conditional render"
      pattern: "showExportDialog.*ExportDialog"
    - from: "frontend/src/components/Canvas/fileHandling/useExport.ts"
      to: "editor.toImage"
      via: "tldraw API"
      pattern: "editor\\.toImage"
    - from: "frontend/src/components/Canvas/fileHandling/useExport.ts"
      to: "jsPDF"
      via: "import"
      pattern: "import.*jsPDF"
---

<objective>
Add export functionality for PNG and PDF with comprehensive options per CONTEXT.md decisions.

Purpose: FILE-02 and FILE-03 require users to export boards as images and documents. Export dialog provides quick option selection (not a wizard) for scope, background, scale, and PDF layout.

Output: Working export dialog with PNG and PDF download, all options from CONTEXT.md implemented.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-file-handling/06-RESEARCH.md
@.planning/phases/06-file-handling/06-CONTEXT.md
@.planning/phases/06-file-handling/06-01-SUMMARY.md

# Files to modify
@frontend/src/components/Canvas/CustomToolbar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Export utility functions</name>
  <files>
    - frontend/package.json
    - frontend/src/components/Canvas/fileHandling/useExport.ts
  </files>
  <action>
Install jsPDF:
```bash
cd frontend && npm install jspdf
```

Create frontend/src/components/Canvas/fileHandling/useExport.ts:

Types:
```typescript
interface PngExportOptions {
  scope: 'viewport' | 'full'
  background: boolean
  scale: 0.5 | 1 | 2 | 4
}

interface PdfExportOptions {
  scope: 'viewport' | 'full'
  background: boolean
  layout: 'single' | 'multipage'
  orientation: 'portrait' | 'landscape'
  pageSize: 'a4' | 'letter' | 'a3' | 'tabloid' | 'legal'
}
```

exportToPng(editor: Editor, options: PngExportOptions, filename: string): Promise<void>
- Get shapeIds from editor.getCurrentPageShapeIds()
- Throw if no shapes
- Determine bounds: viewport (getViewportPageBounds) or full (getCurrentPageBounds)
- Call editor.toImage() with format, background, scale, bounds, padding: 32
- Download blob using downloadBlob helper

exportToPdf(editor: Editor, options: PdfExportOptions, filename: string): Promise<void>
- Get PNG blob first using editor.toImage (scale: 2 for quality)
- Convert blob to data URL
- Load image to get dimensions
- Create jsPDF with orientation, unit: 'pt', format: pageSize
- For single layout: scale to fit page, center image
- For multipage layout: tile image across pages with y-offset
- Download PDF blob

PAGE_SIZES constant from RESEARCH.md:
```typescript
const PAGE_SIZES = {
  a4: { width: 595.28, height: 841.89 },
  letter: { width: 612, height: 792 },
  a3: { width: 841.89, height: 1190.55 },
  tabloid: { width: 792, height: 1224 },
  legal: { width: 612, height: 1008 },
}
```

downloadBlob helper:
```typescript
function downloadBlob(blob: Blob, filename: string) {
  const url = URL.createObjectURL(blob)
  const link = document.createElement('a')
  link.href = url
  link.download = filename
  link.click()
  URL.revokeObjectURL(url)
}
```

blobToDataUrl and loadImage helpers for PDF conversion.
  </action>
  <verify>
- `grep -n "jspdf" frontend/package.json` shows dependency
- `type frontend\src\components\Canvas\fileHandling\useExport.ts` shows export functions
  </verify>
  <done>
Export utilities ready: exportToPng and exportToPdf with all options from CONTEXT.md.
  </done>
</task>

<task type="auto">
  <name>Task 2: Export dialog component</name>
  <files>
    - frontend/src/components/Canvas/fileHandling/ExportDialog.tsx
  </files>
  <action>
Create frontend/src/components/Canvas/fileHandling/ExportDialog.tsx:

ExportDialog component props:
```typescript
interface ExportDialogProps {
  editor: Editor
  onClose: () => void
}
```

State:
- format: 'png' | 'pdf' (default: 'png')
- scope: 'viewport' | 'full' (default: 'viewport')
- background: boolean (default: true)
- scale: 0.5 | 1 | 2 | 4 (default: 2)
- layout: 'single' | 'multipage' (default: 'single')
- orientation: 'portrait' | 'landscape' (default: 'landscape')
- pageSize: 'a4' | 'letter' | 'a3' | 'tabloid' | 'legal' (default: 'a4')
- isExporting: boolean (loading state)

UI Layout (modal dialog, NOT wizard per CONTEXT.md):
1. Format tabs: PNG | PDF
2. Common options: Scope (viewport/full), Background checkbox
3. PNG-specific: Scale dropdown (0.5x, 1x, 2x, 4x)
4. PDF-specific: Layout (single/multipage), Orientation (portrait/landscape), Page Size dropdown
5. Export button (with loading state)
6. Close button (X in corner)

Styling:
- Modal overlay with semi-transparent backdrop
- Centered dialog with white background
- Consistent with existing app styling (system-ui font, similar spacing)
- zIndex: 500 (above toolbar 300, below connection indicator 1000)

Export handler:
- Set isExporting true
- Generate filename: `board-export-{timestamp}.{format}`
- Call exportToPng or exportToPdf based on format
- Set isExporting false
- Close dialog on success

Click-outside-to-close pattern (like Frames dropdown).
  </action>
  <verify>
- `type frontend\src\components\Canvas\fileHandling\ExportDialog.tsx` shows component
- Component has format tabs, scope options, and format-specific options
  </verify>
  <done>
ExportDialog provides quick option selection and export for PNG/PDF.
  </done>
</task>

<task type="auto">
  <name>Task 3: Toolbar export button integration</name>
  <files>
    - frontend/src/components/Canvas/CustomToolbar.tsx
  </files>
  <action>
Update frontend/src/components/Canvas/CustomToolbar.tsx:

1. Import ExportDialog from './fileHandling/ExportDialog'

2. Add state: const [showExportDialog, setShowExportDialog] = useState(false)

3. Add Export button (after Frames dropdown, before pin button):
```tsx
{/* Export button */}
<button
  onClick={() => setShowExportDialog(true)}
  title="Export Board"
  style={{
    display: 'flex',
    alignItems: 'center',
    justifyContent: 'center',
    height: 32,
    paddingLeft: 10,
    paddingRight: 10,
    border: 'none',
    borderRadius: 6,
    background: 'rgba(255, 255, 255, 0.9)',
    color: '#444',
    cursor: 'pointer',
    boxShadow: '0 1px 3px rgba(0, 0, 0, 0.1)',
    fontSize: 12,
    fontWeight: 500,
    fontFamily: 'system-ui, sans-serif',
    transition: 'background 0.2s, color 0.2s',
  }}
>
  Export
</button>
```

4. Conditionally render ExportDialog:
```tsx
{showExportDialog && (
  <ExportDialog editor={editor} onClose={() => setShowExportDialog(false)} />
)}
```
  </action>
  <verify>
- `grep -n "ExportDialog" frontend/src/components/Canvas/CustomToolbar.tsx` shows import and render
- `grep -n "Export Board" frontend/src/components/Canvas/CustomToolbar.tsx` shows button
  </verify>
  <done>
Toolbar has Export button that opens ExportDialog. Users can export PNG or PDF with all options.
  </done>
</task>

</tasks>

<verification>
1. jsPDF installed: `grep "jspdf" frontend/package.json`
2. Export utilities exist: `type frontend\src\components\Canvas\fileHandling\useExport.ts`
3. Export dialog exists: `type frontend\src\components\Canvas\fileHandling\ExportDialog.tsx`
4. Toolbar integration: `grep "ExportDialog" frontend/src/components/Canvas/CustomToolbar.tsx`
5. No TypeScript errors: `cd frontend && npm run build 2>&1 | head -20`
</verification>

<success_criteria>
- Export button appears in toolbar
- Clicking Export opens dialog with PNG/PDF tabs
- PNG export works with viewport/full, background, and scale options
- PDF export works with viewport/full, background, layout, orientation, and page size options
- Files download with timestamped filenames
- Dialog closes after successful export
</success_criteria>

<output>
After completion, create `.planning/phases/06-file-handling/06-03-SUMMARY.md`
</output>
