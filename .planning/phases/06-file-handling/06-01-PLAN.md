---
phase: 06-file-handling
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - routers/boards.py
  - schemas.py
  - config.py
  - frontend/src/components/Canvas/fileHandling/useAssetStore.ts
  - frontend/src/services/storageApi.ts
  - frontend/src/components/Canvas/Canvas.tsx
autonomous: true

must_haves:
  truths:
    - "Backend can generate presigned URLs for image uploads"
    - "Frontend can request upload URLs from backend"
    - "tldraw receives asset store for persistent image storage"
  artifacts:
    - path: "routers/boards.py"
      provides: "POST /{board_id}/upload-url endpoint"
      contains: "def get_upload_url"
    - path: "frontend/src/components/Canvas/fileHandling/useAssetStore.ts"
      provides: "TLAssetStore implementation"
      exports: ["createAssetStore"]
    - path: "frontend/src/services/storageApi.ts"
      provides: "Presigned URL API client"
      exports: ["requestUploadUrl"]
  key_links:
    - from: "frontend/src/components/Canvas/Canvas.tsx"
      to: "useAssetStore"
      via: "assets prop on Tldraw"
      pattern: "assets=\\{assetStore\\}"
    - from: "frontend/src/components/Canvas/fileHandling/useAssetStore.ts"
      to: "/api/boards/{id}/upload-url"
      via: "storageApi.requestUploadUrl"
      pattern: "requestUploadUrl"
---

<objective>
Create the foundation for image handling: backend presigned URL generation for MinIO uploads and frontend TLAssetStore implementation for tldraw integration.

Purpose: Enable persistent image storage that syncs across collaborators. Images uploaded to the canvas need to be stored externally (MinIO) and resolved by URL for all clients.

Output: Working presigned URL endpoint and asset store that tldraw can use for image persistence.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-file-handling/06-RESEARCH.md
@.planning/phases/06-file-handling/06-CONTEXT.md

# Existing files to modify
@routers/boards.py
@schemas.py
@config.py
@frontend/src/components/Canvas/Canvas.tsx
@frontend/src/services/todoApi.ts (pattern reference for API clients)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Backend presigned URL endpoint</name>
  <files>
    - routers/boards.py
    - schemas.py
    - config.py
  </files>
  <action>
Add MinIO configuration to config.py:
- MINIO_URL (default: http://localhost:9000)
- MINIO_ACCESS_KEY (default: minioadmin)
- MINIO_SECRET_KEY (default: minioadmin)
- MINIO_PUBLIC_URL (default: http://localhost:9000)
- MINIO_BUCKET (default: canvas-assets)

Add schemas to schemas.py:
- UploadUrlRequest: filename (str), contentType (str)
- UploadUrlResponse: uploadUrl (str), assetUrl (str)

Add endpoint to routers/boards.py:
- POST /{board_id}/upload-url
- Requires authentication via get_current_user dependency
- Verify user has edit access to board (owner OR permission with edit level)
- Generate presigned PUT URL using boto3 S3 client
- Key format: boards/{board_id}/{uuid}/{filename}
- Return uploadUrl (presigned) and assetUrl (public URL for storage)
- ExpiresIn: 3600 seconds (1 hour)

NOTE: boto3 is not yet in requirements.txt. Add installation note in summary but don't block on it - the endpoint structure is the priority. Production deployment will configure MinIO.

Pattern from RESEARCH.md:
```python
s3 = boto3_client('s3',
    endpoint_url=settings.MINIO_URL,
    aws_access_key_id=settings.MINIO_ACCESS_KEY,
    aws_secret_access_key=settings.MINIO_SECRET_KEY
)
```
  </action>
  <verify>
- `grep -n "upload-url" routers/boards.py` shows new endpoint
- `grep -n "UploadUrlRequest\|UploadUrlResponse" schemas.py` shows new schemas
- `grep -n "MINIO" config.py` shows MinIO configuration
  </verify>
  <done>
Backend has presigned URL endpoint that accepts filename/contentType and returns upload URL + asset URL.
  </done>
</task>

<task type="auto">
  <name>Task 2: Frontend storage API and asset store</name>
  <files>
    - frontend/src/services/storageApi.ts
    - frontend/src/components/Canvas/fileHandling/useAssetStore.ts
    - frontend/src/components/Canvas/Canvas.tsx
  </files>
  <action>
Create frontend/src/services/storageApi.ts:
- requestUploadUrl(boardId: string, filename: string, contentType: string, token: string): Promise<{uploadUrl: string, assetUrl: string}>
- Use same apiRequest pattern as todoApi.ts
- Endpoint: POST /boards/{boardId}/upload-url

Create frontend/src/components/Canvas/fileHandling/ directory and useAssetStore.ts:
- createAssetStore(boardId: string, token: string): TLAssetStore
- Implements TLAssetStore interface from tldraw:
  - upload(asset, file): Request presigned URL, PUT file to MinIO, return {src: assetUrl}
  - resolve(asset): Return asset.props.src as-is

Pattern from RESEARCH.md:
```typescript
return {
  async upload(asset, file) {
    const { uploadUrl, assetUrl } = await requestUploadUrl(boardId, file.name, file.type, token)
    await fetch(uploadUrl, { method: 'PUT', body: file, headers: { 'Content-Type': file.type } })
    return { src: assetUrl }
  },
  resolve(asset) {
    return asset.props.src
  }
}
```

Update frontend/src/components/Canvas/Canvas.tsx:
- Import createAssetStore from ./fileHandling/useAssetStore
- Create assetStore using useMemo: `useMemo(() => createAssetStore(boardId, token), [boardId, token])`
- Pass to Tldraw: `<Tldraw ... assets={assetStore} />`

Critical per RESEARCH.md: Without assets prop, images work locally but don't persist or sync to collaborators.
  </action>
  <verify>
- `dir frontend\src\components\Canvas\fileHandling` shows useAssetStore.ts
- `dir frontend\src\services` shows storageApi.ts
- `grep -n "assets=" frontend/src/components/Canvas/Canvas.tsx` shows assets prop
  </verify>
  <done>
Frontend has storage API client and TLAssetStore implementation integrated with Canvas component.
  </done>
</task>

</tasks>

<verification>
1. Backend endpoint exists: `grep "upload-url" routers/boards.py`
2. Frontend asset store integrated: `grep "assets=" frontend/src/components/Canvas/Canvas.tsx`
3. No TypeScript errors: `cd frontend && npm run build 2>&1 | head -20` (check for errors)
</verification>

<success_criteria>
- POST /boards/{board_id}/upload-url endpoint accepts filename/contentType
- createAssetStore() returns valid TLAssetStore
- Canvas.tsx passes assets prop to Tldraw component
- Foundation ready for image upload UI in Plan 02
</success_criteria>

<output>
After completion, create `.planning/phases/06-file-handling/06-01-SUMMARY.md`
</output>
